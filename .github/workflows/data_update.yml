# .github/workflows/data_update.yml
name: Data Update / ETL â†’ PR

on:
  workflow_dispatch: {}        # manual trigger from Actions UI
  schedule:
    - cron: '0 2 * * 1'       # weekly Monday 02:00 UTC (change as needed)

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    name: Prepare & Run Data Update
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (for smoke tests)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install python (for ETL)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # install any ETL deps here (add to requirements.txt as needed)
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # (optional) Node deps for smoke test
          if [ -f package.json ]; then npm ci; fi

      - name: Run ETL / data check (placeholder)
        id: run_etl
        env:
          # put environment secrets into repository secrets (Settings -> Secrets)
          FDC_API_KEY: ${{ secrets.FDC_API_KEY || '' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}
        run: |
          set -e
          echo ">> Running data update script (placeholder)"
          # The script below should write any new or updated JSON to data/updates/YYYYMMDD.jsonl
          # Replace with your actual ETL script: etl/update_foods.py --out data/updates/...
          if [ -f ./etl/update_foods.py ]; then
            python etl/update_foods.py --out data/updates/$(date +%F).json
            echo "etl: true" >> $GITHUB_OUTPUT
          else
            echo "No ETL script found - creating a basic sample update file for demo"
            mkdir -p data/updates
            echo '{}' > data/updates/sample-$(date +%s).json
            echo "etl: false" >> $GITHUB_OUTPUT
          fi
          echo "Generated files:"
          ls -la data/updates || true

      - name: Format/validate generated JSON (optional)
        if: always()
        run: |
          # Basic check: is JSON parsable?
          for f in data/updates/*.json || true; do
            if [ -f "$f" ]; then
              python - <<PY
import json,sys
try:
  json.load(open("$f"))
  print("OK:", "$f")
except Exception as e:
  print("BAD JSON:", "$f", e)
  sys.exit(1)
PY
            fi
          done

      - name: Run smoke test (count foods)
        id: smoke
        run: |
          # Simple node script that ensures foods.json is valid and has items
          node -e "const fs=require('fs'); const p='foods.json'; if(!fs.existsSync(p)){console.error('foods.json missing'); process.exit(1);} const j=JSON.parse(fs.readFileSync(p)); console.log('foods.json items:', j.length); if(j.length<1) process.exit(1);"
        continue-on-error: false

      - name: Create update branch and PR (if files changed)
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(data): automated data update $(date +'%F %T')"
          branch: "data-update-$(date +'%Y%m%d-%H%M%S')"
          title: "[data] Automated data update"
          body: |
            This PR was created by the data update workflow.
            
            - Source: automated ETL
            - Files generated: data/updates/
            
            Please review food changes, update provenance, and merge.
          labels: data-update, automated
          base: main
          # Only include changed files under data/
          path: |
            data/**
